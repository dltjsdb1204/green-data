import streamlit as st
import pandas as pd
import plotly.express as px

# 1. 페이지 설정 및 기억장치(session_state) 세팅
st.set_page_config(page_title="그린데이터", layout="wide")

if 'user_condition' not in st.session_state:
    st.session_state.user_condition = "미진단"

# 2. 사이드바 메뉴
st.sidebar.title("🌱 그린데이터 메뉴")
menu = st.sidebar.radio(
    "이동할 페이지를 선택하세요",
    ["홈 (서비스 소개)", "자가진단 (상태 체크)", "치유농가 소개 (매칭)", "나의 치유 리포트 (데이터 열람)"]
)

# --- 탭 1: 홈 (서비스 소개) ---
if menu == "홈 (서비스 소개)":
    st.header("농업이 치료가 되다, 그린데이터")
    st.markdown("### 대한민국은 OECD 국가 중 우울증 유병률 1위입니다.")
    st.write("그린데이터는 고령화로 인한 노인 고립 문제와 2030 세대의 번아웃을 치유농업으로 해결하고자 합니다.")

# --- 탭 2: 자가진단 (상태 체크) ---
elif menu == "자가진단 (상태 체크)":
    st.header("🔍 전문 분야별 자가진단")
    st.write("병원 및 심리상담센터에서 실제 사용하는 공신력 있는 문항입니다. 답변을 모두 체크하고 제출해 주세요.")

    diagnosis_type = st.tabs(["우울증 진단 (BDI)", "치매 선별 (S-SDQ)", "번아웃 증후군"])

    # 1) 우울증 진단 (BDI 전체 21문항)
    with diagnosis_type[0]:
        st.subheader("우울증 진단 (Beck Depression Inventory)")
        st.caption("지난주부터 오늘까지 자신의 상태를 가장 잘 나타내는 문항을 하나씩 골라주세요.")
        
        bdi_questions = [
            ["나는 슬프지 않다.", "나는 슬프다.", "나는 가끔 슬플 때가 있다.", "나는 항상 슬퍼서 그것을 떨쳐버릴 수가 없다."],
            ["나는 앞날에 대해 별로 낙심하지 않는다.", "나는 앞날에 대해 비관적인 느낌이 든다.", "나는 앞날에 대해 기대할 것이 아무 것도 없다고 느낀다.", "나의 앞날은 아주 절망적이고 나아질 가능성이 없다고 느낀다."],
            ["나는 실패자라고 느끼지 않는다.", "나는 보통사람들보다 더 많이 실패한 것 같다.", "내가 살아온 과거를 되돌아보면, 생각나는 것은 실패 뿐이다.", "나는 인간으로서 완전한 실패자인 것 같다."],
            ["나는 전과 같이 일상생활에 만족하고 있다.", "나의 일상생활은 전처럼 즐겁지 않다.", "나는 더 이상 어떤 것에서도 참된 만족을 얻지 못한다.", "나는 모든 것이 다 불만스럽고 지겹다."],
            ["나는 특별히 죄책감을 느끼지 않는다.", "나는 죄책감을 느낄 때가 많다.", "나는 거의 언제나 죄책감을 느낀다.", "나는 항상 언제나 죄책감을 느낀다."],
            ["나는 벌을 받고 있다고 느끼지 않는다.", "나는 아마 벌을 받을 것 같다.", "나는 벌을 받아야 한다고 느낀다.", "나는 지금 벌을 받고 있다고 느낀다."],
            ["나는 나 자신에게 실망하지 않는다.", "나는 나 자신에게 실망하고 있다.", "나는 나 자신이 혐오스럽다.", "나는 나 자신을 증오한다."],
            ["내가 다른 사람보다 못한 것 같지는 않다.", "나는 나의 약점이나 실수에 대해서 나 자신을 탓한다.", "내가 한 일이 잘못되었을 때는 언제나 나를 탓한다.", "일어나는 모든 나쁜 일들은 다 내 탓이다."],
            ["나는 자살같은 것은 생각하지 않는다.", "나는 자살할 생각은 하고 있으나, 실제로 하지는 않을 것이다.", "나는 자살하고 싶다.", "나는 기회만 있으면 자살하겠다."],
            ["나는 평소보다 더 울지는 않는다.", "나는 전보다 더 많이 운다.", "나는 요즈음 항상 운다.", "나는 전에는 울고 싶을 때 울 수 있었지만, 요즈음에는 울래야 울 기력조차 없다."],
            ["나는 요즈음 평소보다 더 많이 짜증을 내는 편이 아니다.", "나는 전보다 더 쉽게 짜증이 나고 귀찮아진다.", "나는 요즈음 항상 짜증스럽다.", "전에는 짜증스럽던 일에 요즈음은 너무 지쳐서 짜증조차 나지 않는다."],
            ["나는 다른 사람들에 대한 관심을 잃지 않고 싶다.", "나는 전보다 다른 사람들에 대한 관심이 줄었다.", "나는 다른 사람들에 대한 관심이 거의 없어졌다.", "나는 다른 사람들에 대한 관심이 없어졌다."],
            ["나는 평소보다 결정을 잘 내린다.", "나는 결정을 미루는 때가 전보다 많다.", "나는 전에 비해 결정을 내리는 데에 더 큰 어려움을 느낀다.", "나는 더 이상 아무 결정도 내릴 수가 없다."],
            ["나는 전보다 내 모습이 더 나빠졌다고 느끼지 않는다.", "나는 나이들어 보이거나 매력없어 보일까봐 걱정한다.", "나는 내 모습이 매력없게 변해 버렸다고 느낀다.", "나는 내가 추하게 보인다고 믿는다."],
            ["나는 전처럼 일을 할 수 있다.", "어떤 일을 시작하려면 나 자신을 매우 심하게 채찍질해야만 한다.", "무슨 일이든 하려면 나 자신을 매우 심하게 채찍질하여야만 한다.", "나는 전혀 아무 일도 할 수 없다."],
            ["나는 평소처럼 잠을 잘 수 있다.", "나는 전처럼 잠을 자지 못한다.", "나는 전보다 한 두시간씩 일찍 깨고 다시 잠들기 어렵다.", "나는 평소보다 몇 시간이나 일찍 깨고 다시 잠들 수 없다."],
            ["나는 평소보다 더 피곤하지는 않다.", "나는 전보다 더 쉽게 피곤해진다.", "나는 무엇을 해도 언제나 피곤해진다.", "나는 너무나 피곤해서 아무 일도 할 수 없다."],
            ["내 식욕은 평소와 다름없다.", "나는 요즈음 전보다 식욕이 좋지 않다.", "나는 요즈음 식욕이 많이 떨어졌다.", "요즈음에는 전혀 식욕이 없다."],
            ["요즈음 체중이 별로 줄지 않았다.", "전보다 몸무게가 2㎏가량 줄었다.", "전보다 몸무게가 5㎏가량 줄었다.", "전보다 몸무게가 7㎏가량 줄었다."],
            ["나는 건강에 대해 전보다 더 염려하고 있지는 않다.", "나는 통증, 소화불량, 변비 등과 같은 신체적인 문제로 걱정하고 있다.", "나는 건강이 매우 염려되어 다른 일은 아무 것도 생각하기 힘들다.", "나는 건강이 너무 염려되어 다른 일은 아무 것도 생각할 수 없다."],
            ["나는 요즈음 성(sex)에 대한 관심에 별다른 변화가 있는 것 같지는 않다.", "나는 전보다 성(sex)에 대한 관심이 줄었다.", "나는 전보다 성(sex)에 대한 관심이 상당히 줄었다.", "나는 성(sex)에 대한 관심이 완전히 줄었다."]
        ]
        
        with st.form("bdi_form"):
            bdi_answers = []
            for i, options in enumerate(bdi_questions):
                choice = st.radio(f"**{i+1}.**", options, key=f"bdi_{i}")
                bdi_answers.append(choice)
            bdi_submitted = st.form_submit_button("우울증 결과 분석")
            
        if bdi_submitted:
            bdi_score = sum([options.index(ans) for options, ans in zip(bdi_questions, bdi_answers)])
            st.info(f"📊 BDI 총점: {bdi_score}점")
            
            if bdi_score >= 16:
                st.error("주의: 총점이 16점 이상으로, 정신과 전문의와의 상의를 요합니다. '치유농가 소개' 탭에서 정서 안정 농장을 확인하세요.")
                st.session_state.user_condition = "우울/스트레스" 
            else:
                st.success("양호: 우울감이 정상 범위입니다. '치유농가 소개' 탭에서 예방/휴식 농장을 확인하세요.")
                st.session_state.user_condition = "예방/휴식"

    # 2) 치매 선별 진단 (S-SDQ 전체 15문항)
    with diagnosis_type[1]:
        st.subheader("단축형 삼성 치매 선별 질문지 (S-SDQ)")
        st.warning("⚠️ 반드시 환자가 아닌 환자의 상태를 잘 아는 보호자가 체크하여야 합니다.")
        st.caption("다음 문항을 읽고 최근 6개월간 환자에게 해당하는 사항에 체크를 하시오.")
        
        ssdq_questions = [
            "1. 언제 어떤 일이 일어났는지 기억하지 못한다.",
            "2. 며칠 전에 들었던 이야기를 잊는다.",
            "3. 반복되는 일상생활에 변화가 생겼을 때 금방 적응하기가 힘들다.",
            "4. 본인에게 중요한 사항을 잊는다. (예를 들어 배우자 생일, 결혼기념일, 제삿날 등)",
            "5. 어떤 일을 해놓고 잊어버려 다시 반복 한다.",
            "6. 약속을 해놓고 잊는다.",
            "7. 이야기 도중 방금 자기가 무슨 이야기를 하고 있었는지를 잊는다.",
            "8. 하고 싶은 말이나 표현이 금방 떠오르지 않는다.",
            "9. 물건 이름이 금방 생각나지 않는다.",
            "10. 텔레비전을 보고 그 내용을 이해하기가 힘들다.",
            "11. 전에 가본 장소를 기억하지 못한다.",
            "12. 길을 잃거나 헤맨 적이 있다.",
            "13. 계산능력이 떨어졌다.",
            "14. 돈 관리를 하는데 실수가 있다.",
            "15. 과거에 쓰던 기구의 사용이 서툴어졌다."
        ]
        ssdq_options = {"그렇지 않다": 0, "간혹(약간) 그렇다": 1, "자주(많이) 그렇다": 2}
        
        with st.form("ssdq_form"):
            ssdq_answers = []
            for i, q in enumerate(ssdq_questions):
                choice = st.select_slider(q, options=list(ssdq_options.keys()), key=f"ssdq_{i}")
                ssdq_answers.append(choice)
            ssdq_submitted = st.form_submit_button("치매 선별 결과 확인")
            
        if ssdq_submitted:
            ssdq_score = sum([ssdq_options[ans] for ans in ssdq_answers])
            st.info(f"📊 S-SDQ 총점: {ssdq_score}점")
            
            if ssdq_score >= 8:
                st.error("치매 의심: 총점이 8점 이상이면 치매가 의심되며 보호자와 함께 내원하여 전문의와 상의하시기 바랍니다. '치유농가 소개' 탭에서 인지 특화 농장을 확인하세요.")
                st.session_state.user_condition = "치매 위험군"
            else:
                st.success("양호: 정상 범위 내에 있습니다.")
                st.session_state.user_condition = "예방/휴식"

    # 3) 번아웃 진단 (마음소풍 6문항)
    with diagnosis_type[2]:
        st.subheader("마음소풍 번아웃 증후군 자가진단")
        
        burnout_questions = [
            "1. 출근하는 생각만 해도 짜증과 함께 가슴이 답답함을 느낀다.",
            "2. 직장에서 칭찬을 들어도 썩 즐거운 기분이 들지 않는다.",
            "3. 직장생활 외에 개인적인 생활이나 시간이 거의 없다.",
            "4. 기력이 없고 쇠약해진 느낌이 든다.",
            "5. 일하는 것에 심적 부담과 자신의 한계를 느낀다.",
            "6. 충분한 시간의 잠을 자도 계속 피곤함을 느낀다."
        ]
        bo_options = {"아니다": 0, "가끔 그렇다": 1, "자주 그렇다": 2}
        
        with st.form("bo_form"):
            bo_answers = []
            for i, q in enumerate(burnout_questions):
                choice = st.radio(q, list(bo_options.keys()), key=f"bo_{i}", horizontal=True)
                bo_answers.append(choice)
            bo_submitted = st.form_submit_button("번아웃 지수 확인")
            
        if bo_submitted:
            bo_score = sum([bo_options[ans] for ans in bo_answers])
            st.info(f"📊 번아웃 점수: {bo_score}점")
            
            if bo_score >= 6:
                st.warning("번아웃 경고: 신체적, 정신적 피로감이 높습니다. '치유농가 소개' 탭에서 힐링 농장을 확인하세요.")
                st.session_state.user_condition = "번아웃"
            else:
                st.success("양호: 에너지를 잘 관리하고 계십니다.")
                st.session_state.user_condition = "예방/휴식"

# --- 탭 3: 치유농가 소개 (매칭) ---
elif menu == "치유농가 소개 (매칭)":
    st.header("🏡 맞춤형 치유농장 큐레이션")
    
    # 진짜 전남치유농가 데이 
# 실제 전남 치유농가 데이터베이스 적용
    farms_data = pd.DataFrame([
        {"농장명": "명하쪽빛마을", "지역": "전남 나주", "핵심프로그램": "전통 쪽 염색, 소일거리 제공", "추천대상": "우울/스트레스", "보유전문성": "조달청 치유프로그램 등록", "편의시설": "숙박 시설, 마을 식당"},
        {"농장명": "화탑영농조합법인", "지역": "전남 나주", "핵심프로그램": "허브 재배 및 원예 상품 제작", "추천대상": "치매 위험군", "보유전문성": "장애인종합복지관 협력(사회적 농업)", "편의시설": "허브 전용 농장, 다목적 체험장"},
        {"농장명": "골망태요리사의 정원", "지역": "전남 보성", "핵심프로그램": "녹차미로정원 체험, 꽃 관람", "추천대상": "번아웃", "보유전문성": "전라남도 제25호 민간정원", "편의시설": "독채 펜션, 뷰 카페, 대형 주차장"},
        {"농장명": "나비천지치유농장", "지역": "전남 함평", "핵심프로그램": "탄소중립 연계 식물 치유", "추천대상": "우울/스트레스", "보유전문성": "지역아동센터 연계 사업", "편의시설": "원예 전용 체험학습장"},
        {"농장명": "지리산과하나되기", "지역": "전남 구례", "핵심프로그램": "산수유빵 만들기, 식초 발효", "추천대상": "예방/휴식", "보유전문성": "구례 1호 국가공인 치유농업사", "편의시설": "베이커리 카페"},
        {"농장명": "다화림식물원&치유정원", "지역": "전남 담양", "핵심프로그램": "수경재배, 테라리움, 식충식물", "추천대상": "번아웃", "보유전문성": "농식품부 융복합사업자 인증", "편의시설": "대형 전시온실, 휴게 정자"}
    ])

    current_condition = st.session_state.user_condition

    if current_condition == "미진단":
        st.warning("앗! 아직 자가진단을 하지 않으셨네요. 정확한 매칭을 위해 먼저 상태를 체크해주세요.")
        st.write("아래는 전체 농가 목록입니다.")
        st.dataframe(farms_data)
        
    else:
        st.success(f"현재 고객님의 상태는 **'{current_condition}'** 특화 프로그램이 필요합니다. 맞춤 농가를 찾았습니다!")
        
        # 추천대상이 일치하는 농가 필터링
        matched_farms = farms_data[farms_data["추천대상"] == current_condition]
        
        # 농가 정보 카드 형태로 출력
        for index, row in matched_farms.iterrows():
            with st.container():
                st.markdown(f"### 🌿 {row['농장명']} ({row['지역']})")
                st.write(f"- **핵심 프로그램:** {row['핵심프로그램']}")
                st.write(f"- **보유 전문성:** {row['보유전문성']}")
                st.write(f"- **편의/부대시설:** {row['편의시설']}")
                st.markdown("---")
                
# --- 탭 4: 나의 치유 리포트 (데이터 열람) ---
elif menu == "나의 치유 리포트 (데이터 열람)":
    st.header("📊 데이터 기반 치유 효과 리포트")
    st.write("웨어러블 API 연동을 통한 객관적 수치 확인 페이지입니다. (현재 준비 중)")
